<div class="container">
	<form class="form-inline" onsubmit="document.location.hash=DB.form2param('.query .row').join('');return false;">
		<h3>Critere de recherche</h3>
		<div class="query"></div>
		<button type="button" class="btn btn-link" onclick="$('.query .row:first').clone().appendTo('.query');"><span class="glyphicon glyphicon-plus"></span> Ajouter un critère supplémentaire</button>
		<button type="submit" class="btn btn-link"><span class="glyphicon glyphicon-search"></span> Rechercher</button>
		<button type="button" class="btn btn-link" onclick="Source.edit()"><span class="glyphicon glyphicon-plus"></span> Créer...</button>
	</form>
	<div class="table-overflow" id="results_list"></div>
</div>

<script>
var bd_table='parcelleunitefiscale';

Source={
	edit:function(){
		var args=this;
		$('#Modal').modal('show');
		DB('option',bd_table).success(
			DB.toForm.bind({table:bd_table,target:'#Modal .modal-body',id:args.id,success:function(id){//id=0 on create, >0 on modified
				Alert('success',(id?'Created :<a href="#&id='+id+'">'+id+'</a>':'Modified'));
				if(args.id)DB('get',bd_table+'/'+args.id).success(function(rows){//ask for the new version
					DB.toRow($('tr[name='+rows[0].id+']'),rows[0],{cell:Source.cell,list:JSON.parse(localStorage.list)})});
				$('#Modal').modal('hide');
		}}));
	},
	list:function(){
		return DB.toList.bind({target:'#results_list',cell:Source.cell,table:bd_table,table_class:'table-condensed'})
	},
	cell:function(args,val,type){
		function btn(ico,oc){return $('<button type="button" class="btn btn-default btn-xs"><span class="glyphicon glyphicon-'+ico+'"></span></button>').on('click',oc);}
		if(type=='id')
			return $('<div class="btn-group" style="display:flex" title="'+val+'">')
				.append(btn('trash',function(){
					DB('delete',args.table+"/"+val).success((function(){
						return $(this).closest('tr').fadeOut(500);
					}).bind(this))
				}))
				.append(btn('pencil'  ,Source.edit.bind({id:val})));
		return val;
	}
};

//deamons
(window.onhashchange=function(ev){//search when query changed/init
	DB.toSearchForm.call({target:'.query',hash:URL(ev.newURL).hash});//update the form
	if(URL(ev.newURL).hash.length>1)//no more hash => do nothing
		DB('find',bd_table+'/'+URL(ev.newURL).hash.slice(1)).success(Source.list());//do the search
})({newURL:document.location.href});//trigger to take into account initial hash

DB('option',bd_table).success(DB.toSearchForm.bind({target:'.query',hash:document.location.hash}));

</script>