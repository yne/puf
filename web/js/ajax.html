<html>
<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css">
<link rel="stylesheet" href="../css/style.css">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script>

Alert=function(type,msg){ /* info,success,warning,danger */
	$("#Alert").removeClass().addClass("alert fade in alert-"+type)
		.html(msg).slideDown(400).delay(4000).slideUp(400);
}

$(document).ajaxError(function(event, jqXHR, ajaxSettings, thrownError){
	Alert('danger',thrownError);
	console.warn(this,arguments);
})

function ressource_edit(){
	$('#Modal').modal('show');
	DB('option','ressource').success(
		DB.toForm.bind({table:'ressource',target:'#Modal .modal-body',id:this.id,success:function(id){
			$('#Modal').modal('hide');
			Alert('success',(this.id?'Modified':'New')+' Ressource:'+id);
	}}));
}
function ressource_list(){
	return DB.toList.bind({target:'#out',cell:ressource_cell,table:'ressource',table_class:'table-condensed'})
}
function ressource_cell(args,val,type){
	function btn(ico,oc){return $('<button type="button" class="btn btn-default btn-sm"><span class="glyphicon glyphicon-'+ico+'"></span></button>').on('click',oc);}
	if(type=='id')
		return $('<div class="btn-group" style="display:flex" title="'+val+'">')
			.append(btn('trash'   ,function(){
				DB('delete',args.table+"/"+val).success((function(){
					return $(this).closest('tr').fadeOut(500);
				}).bind(this))
			}))
			.append(btn('pencil'  ,ressource_edit.bind({id:val})));
	if(type=='href')
		return $('<a href="'+val+'">').html('<span class="glyphicon glyphicon-share-alt"></span>');
	if(['fichedev','bdd','photo'].indexOf(type)>=0)
		return val*1?'&#10004;':'&#10008;';
	return val;
}
</script>
<body>

<div id="Alert"></div>

<div class="modal fade" id="Modal">
	<div class="modal-dialog modal-sm">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal">&times;</button>
				<h4 class="modal-title">&nbsp;</h4>
			</div>
			<div class="modal-body"></div>
		</div>
	</div>
</div>

<style>
#Alert{
	bottom: 1em;
	display: inline;
	position: fixed;
	right: 1em;
	display: none;
}
.query{
	list-style: none;
	margin:0;
}
.query .row:first-child>*:first-child{
	visibility: hidden;
}
.query .row:first-child .btn{
	display: none;
}
.query .row .btn{
	visibility: hidden;
}
.query .row:hover .btn{
	visibility: visible;
}
</style>

<div class="container">
	<form class="form-inline" onsubmit="document.location.hash=DB.form2param('.query .row').join('');return false;">
		<h3>Critere de recherche</h3>
		<div class="query"></div>
		<div id="addQuery" class="btn btn-link" onclick="$('.query .row:first').clone().appendTo('.query');">Ajouter un critère supplémentaire</div>
	</form>
	<div>
		<button onclick="ressource_edit()">add</button>
		<button onclick="DB('get'   ,'ressource').success(ressource_list());">listAll</button>
	</div>
	<div id="out" class="table-responsive"></div>
</div>
</body>
<script src="ajax.js"></script>
<script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
<script>
	(window.onhashchange=function(ev){//search when query changed/init
		if(URL(ev.newURL).hash.length<=1)return;//no more hash => do nothing
		DB('find','ressource/'+URL(ev.newURL).hash.slice(1)).success(ressource_list());//do the search
	})({newURL:document.location.href});//trigger to take into account initial hash
	
	DB('option','ressource').success(DB.toSearchForm.bind({target:'.query'}));
</script>
</html>

