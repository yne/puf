<div class="container">
	<div class="row">
	<div class="col-md-9">
		<h3>Recherche de sources</h3>
			<form class="form-inline" onsubmit="recherche_source();return false;">
			<div id="querybuilder" class="querybuilder" data-url="/v1/parcelleunitefiscale /v1/parcelleunitereelle /v1/proprietaire" data-usehash="true"></div>
			<input type="button" onclick="$('#querybuilder').querybuilder('add')" value="&#43; Ajouter un critère supplémentaire"></input>
			<input type="submit" value="&#8981; Rechercher"></input>
			
			</form>
	</div>
	<div class="col-md-3">
		<h3>Dans les registres :</h3>
		<select multiple class="form-control" id="sel_ressources"></select>
	</div>
</div>
</div>

<div class="table-responsive"><table id="restable" class="restable table table-condensed table-hover"></table></div>

<script src="/js/Source.js"></script>
<script>
(document.getElementById('logo_architerre')||{}).hidden=1
function recherche_source(){
	var q=$('#querybuilder').querybuilder('get'),res=($('#sel_ressources').val()||[]).join(',');
	if(res){q.conj.push('&');q.name.push('id_ressource');q.oper.push(':');q.data.push(res)}
	location.hash=JSON.stringify(q);
	$('#restable').restable('query',"/v1/parcelleunitefiscale/",q);
}
document.body.onload=(function(){
	$('#restable').restable(Source.table())
	//on query box loaded : load the registre list
	$('#querybuilder').on('ready.bs.querybuilder',function(){
		$.getJSON('/v1/parcelleunitefiscale/id_ressource',function(parcelle){
			parcelle.forEach(function(r){$('#sel_ressources').append('<option value="'+r.id_ressource+'">'+r.id_ressource+' ('+r.rows+' entrées)')})
			if(!location.hash || location.hash.length<=2)return;
			if(!isNaN(location.hash.slice(1))){//hash is the register number
			
			}else{//hash is the query search
				$('#querybuilder').querybuilder('set',location.hash.slice(1));
				recherche_source();
			}
		});
	});
})
</script>
